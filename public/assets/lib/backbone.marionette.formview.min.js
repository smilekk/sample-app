/*! marionette-formview - v0.2.2 - 2013-03-11 */
(function(t,i){"use strict";"function"==typeof define&&define.amd?define(["marionette","jquery","underscore"],i):t.Marionette.FormView=i(t.Marionette,t.jQuery,t._)})(this,function(t,i,e){"use strict";var n=t.FormView=t.ItemView.extend({className:"formView",rules:{},fields:{},constructor:function(){if(t.ItemView.prototype.constructor.apply(this,arguments),!this.fields)throw Error("Fields Must Be Provided");this.model||(this.model=new Backbone.Model),this.bindTo(this.model,"change",this.changeFieldVal,this),this.data&&this.model.set(this.data),this.template||this.runInitializers(),this.on("item:rendered",this.runInitializers,this)},changeFieldVal:function(t,i){if(!e.isEmpty(i)){var n=Object.keys(i.changes);this.inputVal(n,this.model.get(n))}},populateFields:function(){e(this.fields).each(function(t,i){var e=this.model.get(i),n=this.$('[data-field="'+i+'"]');this.inputVal(n,e),t.autoFocus&&n.focus()},this)},serializeFormData:function(){var t={},i=this;return e(this.fields).each(function(e,n){t[n]=i.inputVal(n)}),t},beforeFormSubmit:function(t){var i=this.validate(),n=e.isEmpty(i);return n?e.isFunction(this.onSubmit)?this.onSubmit.apply(this,[t]):void 0:(e.isFunction(this.onSubmitFail)&&this.onSubmitFail.apply(this,[i]),t.stopImmediatePropagation(),!1)},onFieldEvent:function(t){this.handleFieldEvent(t,t.type)},handleFieldEvent:function(t,n){var u=t.target||t.srcElement,a=i(u).attr("data-field"),s=this.fields[a];if(s&&s.validateOn===n){var r=this.validateField(a);!e.isEmpty(r)&&e.isFunction(this.onValidationFail)&&this.onValidationFail(r)}},validate:function(){var t={},i=e(this.fields).keys();return e(i).each(function(i){var n=this.validateField(i);e.isEmpty(n)||(t[i]=n)},this),t},validateField:function(t){var i=this.fields[t],n=i&&i.validations?i.validations:{},u=[],a=!0,s=this.inputVal(t);if(i.required){a=this.validateRule(s,"required");var r="string"==typeof i.required?i.required:"This field is required";a||u.push(r)}if(a&&n&&e.each(n,function(t,i){a=this.validateRule(s,i),a||u.push(t)},this),!e.isEmpty(u)){var F={field:t,el:this.fields[t].el,error:u};return F}},inputVal:function(t,e){var n=t.jquery?t:this.$('[data-field="'+t+'"]'),u=this,a=e===void 0?"get":"set";if("object"===n.data("fieldtype"))"get"===a&&(e={}),n.find("[data-property]").each(function(){var t=i(this),n=t.attr("data-property");"get"===a?e[n]=u.inputVal(t):e&&u.inputVal(t,e[n])});else if("array"===n.data("fieldtype"))"get"===a&&(e=[]),n.find("[data-index]").each(function(){var t=i(this),n=t.data("index");"get"===a?e[n]=u.inputVal(t):e&&u.inputVal(t,e[n])});else if(n.is("input")){var s=n.attr("type").toLowerCase();switch(s){case"radio":case"checkbox":"get"===a?e=n.is(":checked"):n.prop("checked",!!e);break;default:"get"===a?e=i.trim(n.val()):n.val(e)}}else n.is("textarea")&&("get"===a?e=n.text():n.text(e)),n.is("select")&&("get"===a?e=i.trim(n.val()):n.val(e));return e},validateRule:function(t,i){var n;if(!i)throw Error("Not passed a validation to test");return"required"===i?u.required(t):(-1!==i.indexOf(":")&&(n=i.split(":"),i=n.shift()),this.rules&&this.rules[i]?e(this.rules[i]).bind(this)(t):e(u.validate).bind(this)(i,t,n))},submit:function(){this.form.submit()},bindFormEvents:function(){var t=this.$el.is("form")?this.$el:this.$("form").first();this.form=t,this.$("input").blur(e(this.onFieldEvent).bind(this)).keyup(e(this.onFieldEvent).bind(this)).keydown(e(this.onFieldEvent).bind(this)).change(e(this.onFieldEvent).bind(this)),t.submit(e(this.beforeFormSubmit).bind(this))},runInitializers:function(){this.populateFields(),this.bindFormEvents(),e.isFunction(this.onReady)&&this.onReady()}}),u={regex:{email:/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,alpha:/^[a-zA-Z]+$/,alphanum:/^[a-zA-Z0-9]+$/},validate:function(t,i,n){if(e.isFunction(u[t]))return e(u[t]).bind(this)(i,n);throw Error("Validator does not exist : "+t)},matches:function(t,i){return t==this.inputVal(i)},min:function(t,i){return i>t.length?!1:!0},max:function(t,i){return t.length>i?!1:!0},numeric:function(t){return e.isNumber(t)},alpha:function(t){return u.regex.alpha.test(t)},alphanum:function(t){return u.regex.alphanum.test(t)},email:function(t){return u.regex.email.test(t)},required:function(t){return t===!1||e.isNull(t)||e.isUndefined(t)||e.isString(t)&&0===t.length?!1:!0},"boolean":function(t){return e.isBoolean(t)}};return n});